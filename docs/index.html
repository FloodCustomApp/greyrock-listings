<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GreyRock CRE - Commercial Properties</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;1,9..40,400&family=Playfair+Display:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
  :root {
    --bg-primary: #0f1114;
    --bg-secondary: #1a1d23;
    --bg-card: #22262e;
    --bg-card-hover: #2a2f38;
    --border: #2e333d;
    --border-light: #3a4050;
    --text-primary: #f0f0f0;
    --text-secondary: #9ba3b0;
    --text-muted: #6b7280;
    --accent: #c8a97e;
    --accent-hover: #d4b98e;
    --accent-dim: rgba(200,169,126,0.15);
    --green: #34d399;
    --red: #f87171;
    --yellow: #fbbf24;
    --radius: 8px;
    --radius-lg: 12px;
    --shadow: 0 4px 24px rgba(0,0,0,0.4);
    --transition: 0.25s cubic-bezier(0.4,0,0.2,1);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--bg-primary);
    color: var(--text-primary);
    line-height: 1.6;
    -webkit-font-smoothing: antialiased;
  }

  .container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 0 24px;
  }

  /* ─── STALE DATA BANNER ─── */
  .stale-banner {
    display: none;
    background: rgba(251,191,36,0.1);
    border: 1px solid rgba(251,191,36,0.3);
    border-radius: var(--radius);
    padding: 12px 20px;
    margin: 16px 0;
    color: var(--yellow);
    font-size: 0.85rem;
    text-align: center;
    align-items: center;
    justify-content: center;
    gap: 8px;
  }

  .stale-banner.visible { display: flex; }

  .stale-banner a {
    color: var(--yellow);
    text-decoration: underline;
  }

  /* ─── LOADING STATE ─── */
  .loading-state {
    text-align: center;
    padding: 80px 20px;
    color: var(--text-muted);
  }

  .loading-spinner {
    width: 40px;
    height: 40px;
    border: 3px solid var(--border);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    margin: 0 auto 16px;
  }

  @keyframes spin { to { transform: rotate(360deg); } }

  /* ─── ERROR STATE ─── */
  .error-state {
    text-align: center;
    padding: 60px 20px;
    color: var(--text-muted);
  }

  .error-state h3 {
    font-family: 'Playfair Display', serif;
    color: var(--text-secondary);
    margin-bottom: 8px;
  }

  .error-state a {
    color: var(--accent);
    text-decoration: none;
  }

  /* ─── HEADER ─── */
  .listings-header {
    padding: 48px 0 32px;
    text-align: center;
    position: relative;
  }

  .listings-header::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 50%;
    transform: translateX(-50%);
    width: 60px;
    height: 2px;
    background: var(--accent);
  }

  .listings-header h1 {
    font-family: 'Playfair Display', serif;
    font-size: 2.4rem;
    font-weight: 600;
    letter-spacing: -0.02em;
    margin-bottom: 8px;
  }

  .listings-header p {
    color: var(--text-secondary);
    font-size: 1.05rem;
    font-weight: 300;
  }

  .listings-count {
    display: inline-block;
    margin-top: 16px;
    padding: 6px 16px;
    background: var(--accent-dim);
    border: 1px solid rgba(200,169,126,0.25);
    border-radius: 20px;
    font-size: 0.85rem;
    color: var(--accent);
    font-weight: 500;
  }

  /* ─── FILTER BAR ─── */
  .filter-bar {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    padding: 20px 24px;
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    margin: 32px 0 24px;
    align-items: center;
  }

  .filter-group {
    display: flex;
    flex-direction: column;
    gap: 4px;
    flex: 1;
    min-width: 150px;
  }

  .filter-group label {
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--text-muted);
    font-weight: 600;
  }

  .filter-group select {
    background: var(--bg-card);
    border: 1px solid var(--border);
    color: var(--text-primary);
    padding: 10px 14px;
    border-radius: var(--radius);
    font-family: inherit;
    font-size: 0.9rem;
    transition: border-color var(--transition);
    outline: none;
    width: 100%;
  }

  .filter-group select:focus { border-color: var(--accent); }

  .filter-actions {
    display: flex;
    gap: 8px;
    align-items: flex-end;
    padding-top: 18px;
  }

  .btn-filter {
    padding: 10px 24px;
    background: var(--accent);
    color: var(--bg-primary);
    border: none;
    border-radius: var(--radius);
    font-family: inherit;
    font-size: 0.9rem;
    font-weight: 600;
    cursor: pointer;
    transition: all var(--transition);
    white-space: nowrap;
  }

  .btn-filter:hover { background: var(--accent-hover); }

  .btn-clear {
    padding: 10px 16px;
    background: transparent;
    color: var(--text-secondary);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    font-family: inherit;
    font-size: 0.9rem;
    cursor: pointer;
    transition: all var(--transition);
    white-space: nowrap;
  }

  .btn-clear:hover {
    border-color: var(--text-secondary);
    color: var(--text-primary);
  }

  /* ─── LAYOUT: MAP + CARDS ─── */
  .listings-layout {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 24px;
    margin-bottom: 48px;
  }

  /* ─── MAP ─── */
  .map-container {
    position: sticky;
    top: 24px;
    height: calc(100vh - 48px);
    max-height: 700px;
    border-radius: var(--radius-lg);
    overflow: hidden;
    border: 1px solid var(--border);
  }

  #map { width: 100%; height: 100%; }

  .leaflet-container { background: var(--bg-secondary); }

  .leaflet-popup-content-wrapper {
    background: var(--bg-card) !important;
    color: var(--text-primary) !important;
    border-radius: var(--radius) !important;
    box-shadow: var(--shadow) !important;
    border: 1px solid var(--border) !important;
  }

  .leaflet-popup-tip { background: var(--bg-card) !important; }

  .leaflet-popup-content {
    margin: 12px 16px !important;
    font-family: 'DM Sans', sans-serif !important;
    line-height: 1.5 !important;
  }

  .popup-title { font-weight: 600; font-size: 0.95rem; margin-bottom: 4px; }
  .popup-address { color: var(--text-secondary); font-size: 0.8rem; margin-bottom: 8px; }
  .popup-price { color: var(--accent); font-weight: 700; font-size: 1.1rem; }
  .popup-meta { display: flex; gap: 12px; margin-top: 4px; font-size: 0.78rem; color: var(--text-muted); }

  .custom-marker {
    background: var(--accent);
    border: 2px solid #fff;
    border-radius: 50%;
    width: 14px;
    height: 14px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.4);
    transition: transform 0.2s ease;
  }

  .custom-marker.active {
    transform: scale(1.5);
    background: #fff;
    border-color: var(--accent);
  }

  /* ─── PROPERTY CARDS ─── */
  .cards-container {
    display: flex;
    flex-direction: column;
    gap: 16px;
    max-height: calc(100vh - 48px);
    overflow-y: auto;
    padding-right: 8px;
  }

  .cards-container::-webkit-scrollbar { width: 4px; }
  .cards-container::-webkit-scrollbar-track { background: transparent; }
  .cards-container::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }

  .property-card {
    display: grid;
    grid-template-columns: 220px 1fr;
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    overflow: hidden;
    cursor: pointer;
    transition: all var(--transition);
  }

  .property-card:hover {
    border-color: var(--accent);
    background: var(--bg-card-hover);
    transform: translateY(-2px);
    box-shadow: var(--shadow);
  }

  .property-card.active {
    border-color: var(--accent);
    box-shadow: 0 0 0 1px var(--accent), var(--shadow);
  }

  .card-image {
    width: 100%;
    height: 100%;
    min-height: 200px;
    object-fit: cover;
    background: var(--bg-secondary);
  }

  .card-image-placeholder {
    width: 100%;
    height: 100%;
    min-height: 200px;
    background: linear-gradient(135deg, var(--bg-secondary) 0%, #2a2f38 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text-muted);
    font-size: 0.8rem;
  }

  .card-image-placeholder svg {
    width: 48px;
    height: 48px;
    opacity: 0.3;
  }

  .card-body {
    padding: 20px 24px;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
  }

  .card-type {
    display: inline-block;
    padding: 3px 10px;
    background: var(--accent-dim);
    color: var(--accent);
    border-radius: 4px;
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    font-weight: 600;
    margin-bottom: 10px;
  }

  .card-title {
    font-family: 'Playfair Display', serif;
    font-size: 1.15rem;
    font-weight: 600;
    line-height: 1.3;
    margin-bottom: 4px;
  }

  .card-address {
    color: var(--text-secondary);
    font-size: 0.85rem;
    margin-bottom: 12px;
  }

  .card-description {
    color: var(--text-muted);
    font-size: 0.82rem;
    line-height: 1.5;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    margin-bottom: 16px;
  }

  .card-bottom {
    display: flex;
    justify-content: space-between;
    align-items: flex-end;
  }

  .card-price {
    font-size: 1.3rem;
    font-weight: 700;
    color: var(--accent);
  }

  .card-price span {
    font-size: 0.78rem;
    font-weight: 400;
    color: var(--text-muted);
  }

  .card-meta { display: flex; gap: 16px; }

  .meta-item { text-align: right; }
  .meta-value { font-size: 0.95rem; font-weight: 600; }
  .meta-label { font-size: 0.68rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; }

  .card-status { display: inline-flex; align-items: center; gap: 5px; font-size: 0.75rem; font-weight: 500; margin-top: 10px; }
  .card-status.available { color: var(--green); }
  .card-status.coming-soon { color: var(--accent); }

  .status-dot { width: 6px; height: 6px; border-radius: 50%; display: inline-block; }
  .available .status-dot { background: var(--green); }
  .coming-soon .status-dot { background: var(--accent); }

  .card-cta {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    color: var(--accent);
    font-size: 0.82rem;
    font-weight: 600;
    text-decoration: none;
    margin-top: 12px;
    transition: gap var(--transition);
  }

  .card-cta:hover { gap: 10px; }

  /* ─── NO RESULTS ─── */
  .no-results {
    grid-column: 1 / -1;
    text-align: center;
    padding: 60px 20px;
    color: var(--text-muted);
  }

  .no-results h3 {
    font-family: 'Playfair Display', serif;
    font-size: 1.4rem;
    color: var(--text-secondary);
    margin-bottom: 8px;
  }

  /* ─── NO VACANCIES ─── */
  .no-vacancies {
    text-align: center;
    padding: 80px 20px;
  }

  .no-vacancies h2 {
    font-family: 'Playfair Display', serif;
    font-size: 1.8rem;
    margin-bottom: 12px;
  }

  .no-vacancies p {
    color: var(--text-secondary);
    max-width: 500px;
    margin: 0 auto 24px;
  }

  .no-vacancies a {
    display: inline-block;
    padding: 12px 32px;
    background: var(--accent);
    color: var(--bg-primary);
    border-radius: var(--radius);
    text-decoration: none;
    font-weight: 600;
    transition: background var(--transition);
  }

  .no-vacancies a:hover { background: var(--accent-hover); }

  /* ─── RESPONSIVE ─── */
  @media (max-width: 1024px) {
    .listings-layout { grid-template-columns: 1fr; }
    .map-container { position: relative; top: 0; height: 400px; max-height: 400px; }
    .cards-container { max-height: none; overflow-y: visible; }
  }

  @media (max-width: 768px) {
    .listings-header h1 { font-size: 1.8rem; }
    .filter-bar { flex-direction: column; gap: 16px; }
    .filter-group { min-width: 100%; }
    .filter-actions { width: 100%; padding-top: 8px; }
    .filter-actions .btn-filter { flex: 1; text-align: center; }
    .property-card { grid-template-columns: 1fr; }
    .card-image, .card-image-placeholder { min-height: 180px; max-height: 200px; }
  }

  /* ─── ANIMATIONS ─── */
  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(16px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .property-card { animation: fadeUp 0.4s ease both; }
  .property-card:nth-child(2) { animation-delay: 0.05s; }
  .property-card:nth-child(3) { animation-delay: 0.1s; }
  .property-card:nth-child(4) { animation-delay: 0.15s; }
  .property-card:nth-child(5) { animation-delay: 0.2s; }
  .property-card:nth-child(6) { animation-delay: 0.25s; }
</style>
</head>
<body>

<div class="container">
  <!-- Stale data warning banner -->
  <div class="stale-banner" id="staleBanner">
    ⚠️ Listings may not reflect the latest availability.
    <a href="https://greyrockcommercial.appfolio.com/listings" target="_blank">View all listings on AppFolio →</a>
  </div>

  <!-- Header -->
  <div class="listings-header">
    <h1>Commercial Properties for Lease</h1>
    <p>Charlotte Metro Area &mdash; Retail, Office, Industrial &amp; Mixed-Use</p>
    <div class="listings-count" id="listingsCount">Loading...</div>
  </div>

  <!-- Loading state -->
  <div class="loading-state" id="loadingState">
    <div class="loading-spinner"></div>
    <p>Loading available properties...</p>
  </div>

  <!-- Error state (hidden by default) -->
  <div class="error-state" id="errorState" style="display:none;">
    <h3>Unable to Load Listings</h3>
    <p>Please visit <a href="https://greyrockcommercial.appfolio.com/listings" target="_blank">our AppFolio page</a> to view current availability, or <a href="https://www.greyrockcre.com/contact">contact us</a> directly.</p>
  </div>

  <!-- No vacancies state (hidden by default) -->
  <div class="no-vacancies" id="noVacancies" style="display:none;">
    <h2>No Properties Currently Available</h2>
    <p>We don't have any vacancies right now, but availability changes frequently. Contact our team to discuss upcoming spaces or to be added to our waitlist.</p>
    <a href="https://www.greyrockcre.com/contact">Contact Our Team</a>
  </div>

  <!-- Filter Bar (hidden until data loads) -->
  <div class="filter-bar" id="filterBar" style="display:none;">
    <div class="filter-group">
      <label>Property Type</label>
      <select id="filterType">
        <option value="">All Types</option>
      </select>
    </div>
    <div class="filter-group">
      <label>Min Price</label>
      <select id="filterMinPrice">
        <option value="">No Min</option>
        <option value="500">$500/mo</option>
        <option value="1000">$1,000/mo</option>
        <option value="2000">$2,000/mo</option>
        <option value="3000">$3,000/mo</option>
        <option value="5000">$5,000/mo</option>
      </select>
    </div>
    <div class="filter-group">
      <label>Max Price</label>
      <select id="filterMaxPrice">
        <option value="">No Max</option>
        <option value="2000">$2,000/mo</option>
        <option value="3000">$3,000/mo</option>
        <option value="5000">$5,000/mo</option>
        <option value="10000">$10,000/mo</option>
        <option value="20000">$20,000+/mo</option>
      </select>
    </div>
    <div class="filter-group">
      <label>Min Sq Ft</label>
      <select id="filterSqFt">
        <option value="">Any Size</option>
        <option value="500">500+ sq ft</option>
        <option value="1000">1,000+ sq ft</option>
        <option value="2500">2,500+ sq ft</option>
        <option value="5000">5,000+ sq ft</option>
        <option value="10000">10,000+ sq ft</option>
      </select>
    </div>
    <div class="filter-group">
      <label>City</label>
      <select id="filterCity">
        <option value="">All Cities</option>
      </select>
    </div>
    <div class="filter-actions">
      <button class="btn-filter" id="applyFilters">Search</button>
      <button class="btn-clear" id="clearFilters">Clear</button>
    </div>
  </div>

  <!-- Map + Cards Layout (hidden until data loads) -->
  <div class="listings-layout" id="listingsLayout" style="display:none;">
    <div class="map-container">
      <div id="map"></div>
    </div>
    <div class="cards-container" id="cardsContainer"></div>
  </div>
</div>

<script>
// ╔══════════════════════════════════════════════════════════════════════════════╗
// ║  CONFIGURATION — Update these when you set up your GitHub repo             ║
// ╚══════════════════════════════════════════════════════════════════════════════╝

// ⬇️ CHANGE THIS to your GitHub Pages URL after setup
const DATA_URL = 'listings.json';
// Example after GitHub Pages setup:
// const DATA_URL = 'https://YOUR_USERNAME.github.io/greyrock-listings/listings.json';

const STALE_THRESHOLD_HOURS = 2;  // Show banner if data is older than this
const APPFOLIO_FALLBACK = 'https://greyrockcommercial.appfolio.com/listings';

// ─── GLOBAL STATE ──────────────────────────────────────────────────────────────
let LISTINGS = [];
let map, markers = {}, activeCardId = null;

// ─── DATA FETCHING ─────────────────────────────────────────────────────────────

async function loadListings() {
  try {
    const response = await fetch(DATA_URL + '?t=' + Date.now()); // cache-bust
    if (!response.ok) throw new Error(`HTTP ${response.status}`);
    
    const data = await response.json();
    
    // Check data freshness
    if (data.meta?.lastUpdated) {
      const updated = new Date(data.meta.lastUpdated);
      const hoursAgo = (Date.now() - updated.getTime()) / (1000 * 60 * 60);
      
      if (hoursAgo > STALE_THRESHOLD_HOURS) {
        document.getElementById('staleBanner').classList.add('visible');
      }
    }

    // Handle no vacancies
    if (data.meta?.noVacancies || data.listings.length === 0) {
      showNoVacancies();
      return;
    }

    LISTINGS = data.listings;
    initializeUI();
    
  } catch (err) {
    console.error('Failed to load listings:', err);
    showError();
  }
}

// ─── UI STATE MANAGEMENT ───────────────────────────────────────────────────────

function showNoVacancies() {
  document.getElementById('loadingState').style.display = 'none';
  document.getElementById('noVacancies').style.display = 'block';
  document.getElementById('listingsCount').textContent = 'No Current Vacancies';
}

function showError() {
  document.getElementById('loadingState').style.display = 'none';
  document.getElementById('errorState').style.display = 'block';
  document.getElementById('listingsCount').textContent = 'Unable to Load';
}

function initializeUI() {
  document.getElementById('loadingState').style.display = 'none';
  document.getElementById('filterBar').style.display = 'flex';
  document.getElementById('listingsLayout').style.display = 'grid';

  // Populate dynamic filter options
  populateFilters();
  
  // Initialize map
  initMap();
  
  // Render
  renderCards(LISTINGS);
  renderMarkers(LISTINGS);
}

function populateFilters() {
  // Property types
  const types = [...new Set(LISTINGS.map(l => l.type).filter(Boolean))].sort();
  const typeSelect = document.getElementById('filterType');
  types.forEach(t => {
    const opt = document.createElement('option');
    opt.value = t;
    opt.textContent = t;
    typeSelect.appendChild(opt);
  });

  // Cities
  const cities = [...new Set(LISTINGS.map(l => l.city).filter(Boolean))].sort();
  const citySelect = document.getElementById('filterCity');
  cities.forEach(c => {
    const opt = document.createElement('option');
    opt.value = c;
    opt.textContent = c;
    citySelect.appendChild(opt);
  });
}

// ─── MAP SETUP ─────────────────────────────────────────────────────────────────

function initMap() {
  map = L.map('map', { zoomControl: true, scrollWheelZoom: true }).setView([35.32, -80.85], 10);

  L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a> &copy; <a href="https://carto.com/">CARTO</a>',
    subdomains: 'abcd',
    maxZoom: 19
  }).addTo(map);
}

function createIcon(active = false) {
  return L.divIcon({
    className: 'custom-marker' + (active ? ' active' : ''),
    iconSize: [14, 14],
    iconAnchor: [7, 7],
    popupAnchor: [0, -10]
  });
}

// ─── RENDER FUNCTIONS ──────────────────────────────────────────────────────────

function renderCards(listings) {
  const container = document.getElementById('cardsContainer');
  const countEl = document.getElementById('listingsCount');

  if (listings.length === 0) {
    container.innerHTML = `
      <div class="no-results">
        <h3>No Properties Found</h3>
        <p>Try adjusting your filters or clearing the search.</p>
      </div>`;
    countEl.textContent = '0 Properties Found';
    return;
  }

  countEl.textContent = `${listings.length} Available Propert${listings.length === 1 ? 'y' : 'ies'}`;

  container.innerHTML = listings.map(l => {
    const rent = l.rent ? `$${l.rent.toLocaleString()}` : 'Contact';
    const perSF = (l.rent && l.sqft) ? `$${(l.rent / l.sqft * 12).toFixed(2)}` : '—';
    const sqftDisplay = l.sqft ? l.sqft.toLocaleString() : '—';
    const imageHTML = l.imageUrl 
      ? `<img class="card-image" src="${l.imageUrl}" alt="${l.title}" loading="lazy">`
      : `<div class="card-image-placeholder">
           <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
             <rect x="3" y="3" width="18" height="18" rx="2"/>
             <path d="M3 9h18M9 3v18"/>
             <circle cx="15" cy="15" r="2"/>
           </svg>
         </div>`;

    return `
    <div class="property-card" data-id="${l.id}" onclick="highlightProperty('${l.id}')">
      ${imageHTML}
      <div class="card-body">
        <div class="card-top">
          <span class="card-type">${l.type || 'Commercial'}</span>
          <div class="card-title">${l.title}</div>
          <div class="card-address">${l.address || ''}</div>
          <div class="card-description">${l.description || ''}</div>
        </div>
        <div class="card-bottom">
          <div>
            <div class="card-price">${rent} <span>/mo</span></div>
            <div class="card-status ${l.status || 'available'}">
              <span class="status-dot"></span>
              ${l.status === 'available' ? 'Available Now' : 'Available ' + (l.available || '')}
            </div>
          </div>
          <div class="card-meta">
            <div class="meta-item">
              <div class="meta-value">${sqftDisplay}</div>
              <div class="meta-label">Sq Ft</div>
            </div>
            <div class="meta-item">
              <div class="meta-value">${perSF}</div>
              <div class="meta-label">$/SF/YR</div>
            </div>
          </div>
        </div>
        <a class="card-cta" href="${l.detailUrl || l.applyUrl || APPFOLIO_FALLBACK}" target="_blank" onclick="event.stopPropagation()">
          View Details &amp; Apply
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
        </a>
      </div>
    </div>`;
  }).join('');
}

function renderMarkers(listings) {
  Object.values(markers).forEach(m => map.removeLayer(m));
  markers = {};
  const bounds = [];

  listings.forEach(l => {
    if (!l.lat || !l.lng) return;

    const rent = l.rent ? `$${l.rent.toLocaleString()}/mo` : 'Contact';
    const marker = L.marker([l.lat, l.lng], { icon: createIcon() })
      .addTo(map)
      .bindPopup(`
        <div class="popup-title">${l.title}</div>
        <div class="popup-address">${l.address || ''}</div>
        <div class="popup-price">${rent}</div>
        <div class="popup-meta">
          <span>${l.sqft ? l.sqft.toLocaleString() + ' sq ft' : ''}</span>
          <span>${l.type || ''}</span>
        </div>
      `, { closeButton: false });

    marker.on('click', () => highlightProperty(l.id));
    markers[l.id] = marker;
    bounds.push([l.lat, l.lng]);
  });

  if (bounds.length > 0) {
    map.fitBounds(bounds, { padding: [40, 40], maxZoom: 12 });
  }
}

function highlightProperty(id) {
  if (activeCardId) {
    const prevCard = document.querySelector(`.property-card[data-id="${activeCardId}"]`);
    if (prevCard) prevCard.classList.remove('active');
    if (markers[activeCardId]) markers[activeCardId].setIcon(createIcon(false));
  }

  activeCardId = id;
  const card = document.querySelector(`.property-card[data-id="${id}"]`);
  if (card) {
    card.classList.add('active');
    card.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  }

  if (markers[id]) {
    markers[id].setIcon(createIcon(true));
    markers[id].openPopup();
    map.panTo(markers[id].getLatLng(), { animate: true });
  }
}

// ─── FILTERS ───────────────────────────────────────────────────────────────────

function applyFilters() {
  const type = document.getElementById('filterType').value;
  const minPrice = parseInt(document.getElementById('filterMinPrice').value) || 0;
  const maxPrice = parseInt(document.getElementById('filterMaxPrice').value) || Infinity;
  const minSqft = parseInt(document.getElementById('filterSqFt').value) || 0;
  const city = document.getElementById('filterCity').value;

  const filtered = LISTINGS.filter(l => {
    if (type && l.type !== type) return false;
    if (l.rent && l.rent < minPrice) return false;
    if (l.rent && l.rent > maxPrice) return false;
    if (l.sqft && l.sqft < minSqft) return false;
    if (city && l.city !== city) return false;
    return true;
  });

  activeCardId = null;
  renderCards(filtered);
  renderMarkers(filtered);
}

function clearFilters() {
  document.getElementById('filterType').value = '';
  document.getElementById('filterMinPrice').value = '';
  document.getElementById('filterMaxPrice').value = '';
  document.getElementById('filterSqFt').value = '';
  document.getElementById('filterCity').value = '';
  activeCardId = null;
  renderCards(LISTINGS);
  renderMarkers(LISTINGS);
}

// ─── EVENT LISTENERS ───────────────────────────────────────────────────────────
document.getElementById('applyFilters').addEventListener('click', applyFilters);
document.getElementById('clearFilters').addEventListener('click', clearFilters);
document.querySelectorAll('.filter-bar select').forEach(el => {
  el.addEventListener('change', applyFilters);
});

// ─── INIT ──────────────────────────────────────────────────────────────────────
loadListings();
</script>

</body>
</html>
